



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Compare nanopore signal to find modifications">
      
      
        <link rel="canonical" href="https://tleonardi.github.io/nanocompore/data_preparation/">
      
      
        <meta name="author" content="Adrien Leger & Tommaso Leonardi">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Data preparation - Nanocompore</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#data-preparation" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://tleonardi.github.io/nanocompore/" title="Nanocompore" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Nanocompore
            </span>
            <span class="md-header-nav__topic">
              Data preparation
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/tleonardi/nanocompore/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    tleonardi/nanocompore
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://tleonardi.github.io/nanocompore/" title="Nanocompore" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Nanocompore
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/tleonardi/nanocompore/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    tleonardi/nanocompore
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../installation/" title="Installation instructions" class="md-nav__link">
      Installation instructions
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data preparation
      </label>
    
    <a href="./" title="Data preparation" class="md-nav__link md-nav__link--active">
      Data preparation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reads-basecalling" title="Reads basecalling" class="md-nav__link">
    Reads basecalling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transcriptome-alignment" title="Transcriptome alignment" class="md-nav__link">
    Transcriptome alignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#read-indexing-and-resquiggling" title="Read indexing and resquiggling" class="md-nav__link">
    Read indexing and resquiggling
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Usage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/" title="How to use Nanocompore" class="md-nav__link">
      How to use Nanocompore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../demo/SampComp_usage/" title="Compare samples with SampComp" class="md-nav__link">
      Compare samples with SampComp
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../demo/SampCompDB_usage/" title="Generate plots and tables with SampCompDB" class="md-nav__link">
      Generate plots and tables with SampCompDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../demo/SimReads_usage/" title="Generate simulated reads" class="md-nav__link">
      Generate simulated reads
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../alternative/" title="Alternative and complementary packages" class="md-nav__link">
      Alternative and complementary packages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Getting involved and finding help
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Getting involved and finding help
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_of_conduct/" title="Code of conduct" class="md-nav__link">
      Code of conduct
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../licence/" title="Licence" class="md-nav__link">
      Licence
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reads-basecalling" title="Reads basecalling" class="md-nav__link">
    Reads basecalling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transcriptome-alignment" title="Transcriptome alignment" class="md-nav__link">
    Transcriptome alignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#read-indexing-and-resquiggling" title="Read indexing and resquiggling" class="md-nav__link">
    Read indexing and resquiggling
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/tleonardi/nanocompore/edit/master/docs/data_preparation.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="data-preparation">Data preparation</h1>
<p>Before using nanocompore, sequencing data have to be basecalled (Albacore or Guppy), aligned on a transcriptome reference and resquiggled with Nanopolish.</p>
<p>To simplify the data preprocessing we wrote a Nextflow pipeline which automatises all these steps as well as extra quality control steps: <a href="https://github.com/tleonardi/nanocompore_pipeline">https://github.com/tleonardi/nanocompore_pipeline</a></p>
<h3 id="reads-basecalling">Reads basecalling</h3>
<p>Firstly, raw fast5 reads have to be basecalled with a recent version of ONT basecaller. Basecalled fast5 files are not required for the rest of the analysis, only the raw fast5 and the basecalled fastq.</p>
<p>Example with <a href="https://community.nanoporetech.com/downloads">Guppy v2.3.5</a></p>
<div class="codehilite"><pre><span></span>guppy_basecaller -i <span class="o">{</span>raw_fast5_dir<span class="o">}</span> -s <span class="o">{</span>dest_dir<span class="o">}</span> --flowcell <span class="o">{</span>flowcell_id<span class="o">}</span> --kit <span class="o">{</span>Kit_id<span class="o">}</span> -r --calib_detect --enable_trimming <span class="nb">true</span> --trim_strategy rna --reverse_sequence <span class="nb">true</span>
</pre></div>

<p>Then the output fastq files should be concatenated in a single one.</p>
<div class="codehilite"><pre><span></span>cat <span class="o">{</span>dir_to guppy output<span class="o">}</span>/*.fastq &gt; <span class="o">{</span>basecalled_fastq<span class="o">}</span>
</pre></div>

<h3 id="transcriptome-alignment">Transcriptome alignment</h3>
<p>Basecalled reads have to be aligned to a reference. For dRNA-Seq, reads should be aligned to a reference <strong>transcriptome (not genome)</strong> in a non-spliced fashion. For example, one can download reference transcriptome fasta files directly from Gencode for <a href="ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_29/gencode.v29.transcripts.fa.gz">human</a> and <a href="ftp://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M20/gencode.vM20.transcripts.fa.gz">mouse</a>.</p>
<p>Bam files have to be filtered to remove any reads that would be unmapped, secondary and supplementary as well as reads mapped on the reverse strand (SAM flag 2324). We also recommend to discard reads with a very low alignment score (MAPQ&lt;10). Finally, reads have then to be sorted and indexed.</p>
<p>Example with <a href="https://github.com/lh3/minimap2">Minimap2 v2.16</a></p>
<div class="codehilite"><pre><span></span>minimap2 -ax map-ont -L <span class="o">{</span>transcriptome_fasta<span class="o">}</span> <span class="o">{</span>basecalled_fastq<span class="o">}</span> <span class="p">|</span> samtools view -bh -F <span class="m">2324</span> -q <span class="m">10</span> <span class="p">|</span> samtools sort -O bam &gt; <span class="o">{</span>aligned_reads_bam<span class="o">}</span>

samtools index <span class="o">{</span>aligned_reads_bam<span class="o">}</span>
</pre></div>

<h3 id="read-indexing-and-resquiggling">Read indexing and resquiggling</h3>
<p>Nanopolish is required to realign raw signal to the expected reference sequence. Reads have to be indexed first with nanopolish index, realigned with nanopolish eventalign and finally the data has to be collapsed per kmer and indexed by NanopolishComp Eventalign_collapse.</p>
<p>Example with <a href="https://github.com/jts/nanopolish">Nanopolish v0.10.1</a> and <a href="https://github.com/a-slide/NanopolishComp">NanopolishComp v0.4.3</a></p>
<div class="codehilite"><pre><span></span>nanopolish index -s <span class="o">{</span>sequencing_summary.txt<span class="o">}</span> -d <span class="o">{</span>raw_fast5_dir<span class="o">}</span> <span class="o">{</span>basecalled_fastq<span class="o">}</span>

nanopolish eventalign --reads <span class="o">{</span>basecalled_fastq<span class="o">}</span> --bam <span class="o">{</span>aligned_reads_bam<span class="o">}</span> --genome <span class="o">{</span>transcriptome_fasta<span class="o">}</span> --samples --print-read-names --scale-events --samples &gt; <span class="o">{</span>eventalign_reads_tsv<span class="o">}</span>

NanopolishComp Eventalign_collapse -i <span class="o">{</span>eventalign_reads_tsv<span class="o">}</span> -o <span class="o">{</span>eventalign_collapsed_reads_tsv<span class="o">}</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../installation/" title="Installation instructions" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Installation instructions
              </span>
            </div>
          </a>
        
        
          <a href="../usage/" title="How to use Nanocompore" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                How to use Nanocompore
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 Adrien Leger & Tommaso Leonardi
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>